<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ann Arbor Parking Citations Map</title>

    <!-- Meta Tags for Rich Previews -->
    <meta
      name="description"
      content="Interactive map of Ann Arbor parking citations"
    />
    <meta name="author" content="ammar ateya" />

    <!-- Open Graph Tags -->
    <meta property="og:title" content="Ann Arbor Parking Citations Map" />
    <meta
      property="og:description"
      content="Interactive map showing parking citations across Ann Arbor, MI. Real-time tracking of parking tickets with search and notifications."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ og_url }}" />
    <meta property="og:image" content="{{ og_image }}" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:site_name" content="Ann Arbor Parking Citations" />

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Ann Arbor Parking Citations Map" />
    <meta
      name="twitter:description"
      content="Interactive map showing parking citations across Ann Arbor, MI. Real-time tracking of parking tickets with search and notifications."
    />
    <meta name="twitter:image" content="{{ og_image }}" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/icon.png" />
    <link rel="apple-touch-icon" href="/icon.png" />

    <!-- Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-J001JG2NJ1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-J001JG2NJ1", {
        page_title: "Main Page",
        page_location: window.location.href,
      });
      gtag("event", "page_view", {
        page_title: "Main Page",
        page_location: window.location.href,
      });
    </script>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Leaflet MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="static/css/map.css" />
  </head>
  <body>
    <!-- Search Bar (fixed at top, always visible) -->
    <div class="search-bar-panel" id="searchBarPanel">
      <button class="search-menu-btn" id="searchMenuBtn" title="Menu">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      <div class="search-spinner" id="searchSpinner" style="display: none;"></div>
      <input 
        type="text" 
        class="search-input" 
        id="mainSearchInput"
        placeholder="Search plates, citations..."
      />
      <button class="search-submit-btn" id="searchSubmitBtn" title="Search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
      </button>
      <button class="search-clear-btn" id="searchClearBtn" title="Clear" style="display: none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Side Panel (Google Maps style) -->
    <div class="side-panel" id="sidePanel">
      <!-- Photos Hero (at top of side panel) -->
      <div class="photos-hero" id="photosHero" style="display: none;">
        <div class="hero-loading-spinner" id="heroLoadingSpinner">
          <div class="spinner"></div>
        </div>
        <img class="hero-image" id="heroImage" src="" alt="Citation photo" />
        <!-- See photos popup (Google Maps style) - shown on hover -->
        <button class="see-photos-popup" id="seePhotosPopup">
          <svg class="see-photos-icon" width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
          </svg>
          <span class="see-photos-text">See photos</span>
        </button>
      </div>
      
      <!-- Scrollable content area -->
      <div class="side-panel-content" id="sidePanelContent">
        <div class="info-item">
          <div class="info-label">Select a marker</div>
          <div class="info-value">
            Click on a citation marker to view details
          </div>
        </div>
      </div>

      <!-- Side Panel Gallery View (Google Maps style) -->
      <div class="side-panel-gallery" id="sidePanelGallery" style="display: none;">
        <button class="gallery-back-btn" id="galleryBackBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          <span>Back</span>
        </button>
        <div class="gallery-container">
          <div class="gallery-thumbnails-vertical" id="galleryThumbnailsVertical"></div>
          <div class="gallery-main-image">
            <div class="gallery-loading-spinner" id="galleryLoadingSpinner" style="display: none;">
              <div class="spinner"></div>
            </div>
            <img class="gallery-main-photo" id="galleryMainPhoto" src="" alt="" />
            <div class="gallery-nav">
              <button class="gallery-nav-btn gallery-nav-prev" id="galleryNavPrev" aria-label="Previous">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button class="gallery-nav-btn gallery-nav-next" id="galleryNavNext" aria-label="Next">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <!-- Top Bar (Pills to right of search bar) -->
    <div class="top-bar" id="topBar">
      <!-- Filter Dropdown + Stats Pills -->
      <div class="category-pills" id="categoryPills">
        <select class="filter-dropdown" id="filterDropdown" onchange="filterByTime(this.value)">
          <option value="week" selected>Past Week</option>
          <option value="day">Past 24 Hours</option>
          <option value="hour">Past Hour</option>
          <option value="all">All Time</option>
        </select>
        <button class="stats-pill" id="statsPillCitations">
          <span class="stats-pill-value" id="statsPillCitationsValue">0</span>
          <span class="stats-pill-label">citations</span>
        </button>
        <button class="stats-pill" id="statsPillTotal">
          <span class="stats-pill-value" id="statsPillTotalValue">$0</span>
          <span class="stats-pill-label">total</span>
        </button>
        <button class="stats-pill" id="statsPillToday">
          <span class="stats-pill-value" id="statsPillTodayValue">0</span>
          <span class="stats-pill-label">today</span>
        </button>
      </div>
    </div>
    
    <!-- Info link -->
    <a
      href="/a2-parking/about/"
      class="info-link"
      title="Fun facts & project info"
    >
      <span class="info-icon">?</span>
      <span>Learn more</span>
    </a>

    <!-- Stats bar (floating chips at bottom) -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-item">
        <span class="stat-value" id="totalCitations">0</span>
        <span class="stat-label">citations</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="totalAmount">$0</span>
        <span class="stat-label">total</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="totalCitationsToday">0</span>
        <span class="stat-label">today</span>
      </div>
      <div class="stat-item">
        <span class="stat-value" id="totalAmountToday">$0</span>
        <span class="stat-label">today $</span>
      </div>
    </div>

    <!-- Legend (new color scheme) -->
    <div class="legend" id="legendBar">
      <div class="legend-header">Fine Amount</div>
      <div class="legend-items-row">
        <div class="legend-item">
          <div class="legend-marker" style="background: #EA4335;"></div>
          <span class="legend-text">$76+: <span id="legendRed">0</span></span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background: #FA7B17;"></div>
          <span class="legend-text">$46-75: <span id="legendOrange">0</span></span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background: #FBBC04;"></div>
          <span class="legend-text">$26-45: <span id="legendYellow">0</span></span>
        </div>
        <div class="legend-item">
          <div class="legend-marker" style="background: #34A853;"></div>
          <span class="legend-text">$0-25: <span id="legendGreen">0</span></span>
        </div>
      </div>
    </div>

    <!-- Map controls -->
    <div class="map-controls">
      <button
        class="control-btn"
        onclick="resetView()"
        id="resetBtn"
        title="Reset view"
        aria-label="Reset view"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
        </svg>
      </button>
      <button
        class="control-btn"
        id="riskScoreToggleBtn"
        title="Parking Risk Score"
        aria-label="Parking Risk Score"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 17l10 5 10-5"/>
          <path d="M2 12l10 5 10-5"/>
        </svg>
      </button>
    </div>

    <!-- Location search controls (floating) -->
    <div class="location-search-controls" id="locationSearchControls">
      <div class="radius-control">
        <button class="radius-btn" id="searchRadiusMinus" title="Decrease radius">-</button>
        <input type="range" class="radius-slider" id="searchRadiusSlider" min="50" max="2000" value="250" />
        <button class="radius-btn" id="searchRadiusPlus" title="Increase radius">+</button>
        <span class="radius-value" id="radiusValue">250m</span>
      </div>
      <button class="near-me-btn" id="useMyLocationBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 2v3m0 14v3M2 12h3m14 0h3"/>
        </svg>
        Near me
      </button>
      <button class="cancel-location-btn" id="clearLocationSearch">Cancel</button>
    </div>

    <!-- Notification panel -->
    <div class="notify-panel" id="notifyPanel">
      <div class="notify-panel-title">Get notified</div>
      
      <div class="notify-panel-section">
        <div class="notify-panel-label">Subscribe by</div>
        <select id="notifyMode" class="notify-input" style="margin-bottom: 12px;">
          <option value="plate">License Plate</option>
          <option value="location">Location</option>
        </select>
      </div>
      
      <div id="notifyPlate">
        <div class="notify-panel-section" style="display: flex; gap: 8px;">
          <input
            id="notifyPlateState"
            placeholder="MI"
            maxlength="2"
            class="notify-input"
            style="width: 60px; text-transform: uppercase;"
          />
          <input
            id="notifyPlateNumber"
            placeholder="ABC1234"
            class="notify-input"
            style="flex: 1;"
          />
        </div>
      </div>
      
      <div id="notifyLocation" style="display: none;">
        <div class="notify-panel-section">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button class="near-me-btn" id="notifyUseMyLocationBtn" style="flex: 1;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 2v3m0 14v3M2 12h3m14 0h3"/>
              </svg>
              Use my location
            </button>
            <button class="near-me-btn" id="notifyPickCenterBtn">Pick on map</button>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input
              id="notifyRadiusMeters"
              type="number"
              min="10"
              max="5000"
              value="250"
              class="notify-input"
              style="width: 80px;"
            />
            <span style="color: #5f6368; font-size: 14px;">meters radius</span>
          </div>
          <div id="notifyPickedText" style="color: #5f6368; font-size: 12px; margin-top: 8px;"></div>
        </div>
      </div>
      
      <div class="notify-panel-section">
        <input
          id="notifyEmail"
          type="email"
          placeholder="your@email.com"
          class="notify-input"
        />
      </div>
      
      <button class="notify-btn" id="notifySubmitBtn">Subscribe</button>
      <div id="notifyMsg" style="font-size: 12px; color: #5f6368; margin-top: 8px; text-align: center;"></div>
    </div>

    <!-- Risk score panel -->
    <div class="notify-panel" id="riskScorePanel" style="display: none;">
      <div class="notify-panel-title">Parking Risk Assessment</div>
      
      <div class="notify-panel-section">
        <div class="notify-panel-label">Location</div>
        <div style="display: flex; gap: 8px;">
          <input
            id="riskAddress"
            placeholder="Enter address..."
            class="notify-input"
            style="flex: 1;"
          />
          <button class="near-me-btn" id="riskUseMyLocationBtn" title="Use my location">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 2v3m0 14v3M2 12h3m14 0h3"/>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="notify-panel-section">
        <div class="notify-panel-label">Duration</div>
        <div style="display: flex; gap: 8px;">
          <input
            id="riskDuration"
            type="number"
            min="0.25"
            max="168"
            step="0.25"
            value="1"
            class="notify-input"
            style="width: 80px;"
          />
          <select id="riskDurationUnit" class="notify-input" style="flex: 1;">
            <option value="hours">hours</option>
            <option value="days">days</option>
          </select>
        </div>
      </div>
      
      <div class="notify-panel-section">
        <div class="notify-panel-label">When</div>
        <div style="display: flex; gap: 8px;">
          <select id="riskDay" class="notify-input" style="flex: 1;">
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
          </select>
          <input
            id="riskTime"
            type="time"
            class="notify-input"
            style="width: 120px;"
          />
        </div>
      </div>
      
      <button class="notify-btn" id="riskCalculateBtn">Calculate Risk</button>
      
      <div id="riskResult" style="display: none; margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
        <div id="riskResultText" style="font-size: 14px; line-height: 1.6; color: #202124;"></div>
        <div id="riskResultDetails" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dadce0; font-size: 12px; color: #5f6368;"></div>
      </div>
      <div id="riskMsg" style="font-size: 12px; color: #5f6368; margin-top: 8px; text-align: center;"></div>
    </div>

    <!-- Loading indicator -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <span class="loading-text">Loading citations...</span>
    </div>

    <!-- No results message -->
    <div class="no-results-message" id="noResultsMessage">
      <div class="no-results-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#5f6368" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
          <path d="M8 8l6 6M14 8l-6 6"/>
        </svg>
      </div>
      <div class="no-results-title">No citations found</div>
      <div class="no-results-subtitle" id="noResultsInterval">Try adjusting your search or time filter</div>
    </div>

    <!-- Hidden legacy elements for JS compatibility -->
    <input type="hidden" id="searchRadiusMeters" value="250" />
    <input type="hidden" id="searchPlateState" />
    <input type="hidden" id="searchPlateNumber" />
    <input type="hidden" id="searchCitationNumber" />
    <div id="searchPickedLocationText" style="display:none;"></div>
    <div id="searchPanel" style="display:none;"></div>
    <div id="searchHint" style="display:none;"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Photo Viewer Modal -->
    <div id="photoViewer" class="photo-viewer" style="display: none;">
      <div class="photo-viewer-header">
        <button class="photo-viewer-close" id="photoViewerClose" aria-label="Close">×</button>
      </div>
      <div class="photo-viewer-content">
        <div class="photo-viewer-sidebar" id="photoViewerSidebar">
          <div class="photo-thumbnails-vertical" id="photoThumbnailsVertical"></div>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar"><span class="toggle-icon">◀</span></button>
        <div class="photo-viewer-main" id="photoViewerMain">
          <div class="viewer-loading-spinner" id="viewerLoadingSpinner" style="display: none;"><div class="spinner"></div></div>
          <button class="photo-nav photo-nav-prev" id="photoNavPrev" aria-label="Previous">‹</button>
          <img class="viewer-main-photo" id="viewerMainPhoto" src="" alt="" />
          <button class="photo-nav photo-nav-next" id="photoNavNext" aria-label="Next">›</button>
          <div class="photo-metadata">
            <div class="photo-caption" id="photoCaption"></div>
            <div class="photo-date" id="photoDate"></div>
          </div>
          <div class="photo-minimap" id="photoMinimap"></div>
        </div>
      </div>
    </div>

    <!-- Custom JS -->
    <script src="static/js/map.js?v=4" defer></script>
  </body>
</html>
