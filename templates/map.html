<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ann Arbor Parking Citations Map</title>

    <!-- Meta Tags for Rich Previews -->
    <meta
      name="description"
      content="Interactive map of Ann Arbor parking citations"
    />
    <meta name="author" content="ammar ateya" />

    <!-- Open Graph Tags -->
    <meta property="og:title" content="Ann Arbor Parking Citations Map" />
    <meta
      property="og:description"
      content="Interactive map showing parking citations across Ann Arbor, MI"
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://ammarateya.com/a2-parking" />
    <meta property="og:image" content="https://ammarateya.com/icon.png" />

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Ann Arbor Parking Citations Map" />
    <meta
      name="twitter:description"
      content="Interactive map showing parking citations across Ann Arbor, MI"
    />
    <meta name="twitter:image" content="https://ammarateya.com/icon.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/icon.png" />
    <link rel="apple-touch-icon" href="/icon.png" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Mono", "Monaco", "Menlo", "Consolas", "Liberation Mono",
          monospace;
        background: #0a0a0a;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        position: relative;
      }

      /* Scan line effect */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 255, 0, 0.03),
          rgba(0, 255, 0, 0.03) 1px,
          transparent 1px,
          transparent 2px
        );
        pointer-events: none;
        z-index: 9999;
        animation: scan 8s linear infinite;
      }

      @keyframes scan {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(4px);
        }
      }

      #map {
        height: 100vh;
        width: 100vw;
        margin-left: 0;
        position: fixed;
        z-index: 1;
        transition: width 0.3s ease, margin-left 0.3s ease;
      }

      body.panel-open #map {
        width: calc(100vw - 400px);
        margin-left: 400px;
      }

      /* Header - Retro Terminal Style */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #0a0a0a;
        border-bottom: 3px solid #00ff00;
        z-index: 1000;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: "Press Start 2P", cursive;
        box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
      }

      body.panel-open .header {
        left: 400px;
      }

      .header-title {
        color: #00ff00;
        font-size: 10px;
        text-shadow: 0 0 10px #00ff00;
        letter-spacing: 2px;
      }

      .header-status {
        color: #00ff00;
        font-size: 8px;
        animation: blink 1s infinite;
      }

      /* Info box/link */
      .info-link {
        position: fixed;
        top: 48px;
        right: 20px;
        background: rgba(10, 10, 10, 0.95);
        border: 2px solid #00ff00;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 999;
        text-decoration: none;
        color: #00ff00;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
      }

      .info-link:hover {
        background: #00ff00;
        color: #0a0a0a;
        box-shadow: 0 4px 20px rgba(0, 255, 0, 0.5);
      }

      .info-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid currentColor;
        border-radius: 50%;
        font-size: 11px;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .info-link {
          top: 62px;
          right: 10px;
          padding: 6px 10px;
          font-size: 10px;
        }

        .info-icon {
          width: 14px;
          height: 14px;
          font-size: 10px;
        }
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }

      /* Statistics bar - Circuit board style */
      .stats-bar {
        position: fixed;
        top: 94px;
        left: 0;
        right: 0;
        background: #0a0a0a;
        border-bottom: 2px solid #00ff00;
        z-index: 999;
        padding: 12px 20px;
        display: flex;
        gap: 40px;
        justify-content: flex-start;
        align-items: center;
      }

      body.panel-open .stats-bar {
        left: 400px;
      }

      .stat-item {
        text-align: left;
      }

      .stat-value {
        color: #00ff00;
        font-size: 16px;
        font-weight: bold;
        display: block;
        text-shadow: 0 0 5px #00ff00;
      }

      .stat-label {
        color: #888;
        font-size: 9px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 2px;
      }

      /* Side panel - Retro terminal */
      .side-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 400px;
        height: 100vh;
        background: #0a0a0a;
        border-right: 3px solid #00ff00;
        z-index: 1001;
        overflow-y: auto;
        box-shadow: 4px 0 20px rgba(0, 255, 0, 0.3);
        display: none;
      }

      .side-panel.active {
        display: block;
      }

      .side-panel-header {
        padding: 15px;
        border-bottom: 2px solid #00ff00;
        background: #0a0a0a;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .side-panel-title {
        color: #00ff00;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .side-panel-content {
        padding: 15px;
        color: #00ff00;
        line-height: 1.8;
      }

      .info-item {
        padding: 10px 0;
        border-bottom: 1px solid rgba(0, 255, 0, 0.2);
      }

      .info-label {
        color: #888;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
      }

      .info-value {
        color: #00ff00;
        font-size: 12px;
        font-weight: bold;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
      }

      /* Map controls */
      .map-controls {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(10, 10, 10, 0.95);
        border: 2px solid #00ff00;
        padding: 10px;
        display: flex;
        gap: 8px;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
      }

      body.panel-open .map-controls {
        left: 450px;
      }

      /* Legend styles */
      .legend {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(10, 10, 10, 0.95);
        border: 2px solid #00ff00;
        padding: 12px;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
        min-width: 180px;
      }

      body.panel-open .legend {
        right: 420px;
      }

      .legend-header {
        color: #00ff00;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid rgba(0, 255, 0, 0.3);
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
      }

      .legend-marker {
        width: 12px;
        height: 12px;
        border-radius: 0;
      }

      .legend-text {
        color: #00ff00;
        font-size: 11px;
        font-weight: bold;
        letter-spacing: 0.5px;
      }

      .legend-text span {
        color: #00ff00;
        text-shadow: 0 0 5px #00ff00;
      }

      @media (max-width: 768px) {
        .legend {
          bottom: 10px;
          right: 10px;
          padding: 10px;
          min-width: 150px;
        }

        .legend-header {
          font-size: 9px;
        }

        .legend-text {
          font-size: 10px;
        }

        .legend-marker {
          width: 10px;
          height: 10px;
        }
      }

      .control-btn {
        background: #0a0a0a;
        border: 2px solid #00ff00;
        color: #00ff00;
        font-size: 11px;
        font-weight: bold;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .control-btn:hover {
        background: #00ff00;
        color: #0a0a0a;
        text-shadow: none;
      }

      .control-btn.active {
        background: #00ff00;
        color: #0a0a0a;
      }

      /* Popup modal */
      .modal {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 2000;
        animation: fadeIn 0.3s ease;
      }

      .modal.active {
        display: flex;
        flex-direction: column;
      }

      .modal-content {
        background: rgba(20, 20, 20, 0.95);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        border-radius: 28px 28px 0 0;
        padding: 24px;
        max-height: 70vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
      }

      .modal-title {
        color: #fff;
        font-size: 22px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .close-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        width: 32px;
        height: 32px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.2s ease;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-body {
        color: #fff;
      }

      .info-row {
        padding: 12px 0;
        border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: rgba(255, 255, 255, 0.6);
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .info-value {
        color: #fff;
        font-size: 17px;
        font-weight: 600;
      }

      /* Loading indicator - Flashing alarm style */
      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(10, 10, 10, 0.95);
        color: #00ff00;
        padding: 20px 30px;
        border: 3px solid #00ff00;
        border-radius: 0;
        z-index: 3000;
        font-size: 15px;
        font-weight: bold;
        font-family: "Press Start 2P", cursive;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 10px #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5),
          inset 0 0 20px rgba(0, 255, 0, 0.1);
        animation: alarmFlash 0.5s infinite;
      }

      @keyframes alarmFlash {
        0%,
        50% {
          border-color: #00ff00;
          color: #00ff00;
          text-shadow: 0 0 10px #00ff00;
          box-shadow: 0 0 20px rgba(0, 255, 0, 0.5),
            inset 0 0 20px rgba(0, 255, 0, 0.1);
        }
        51%,
        100% {
          border-color: #ff0040;
          color: #ff0040;
          text-shadow: 0 0 10px #ff0040;
          box-shadow: 0 0 20px rgba(255, 0, 64, 0.5),
            inset 0 0 20px rgba(255, 0, 64, 0.1);
        }
      }

      /* Time filter bar */
      .time-filter-bar {
        position: fixed;
        top: 48px;
        left: 0;
        right: 0;
        background: #0a0a0a;
        border-bottom: 2px solid #00ff00;
        z-index: 998;
        padding: 14px 20px 12px 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-start;
        align-items: center;
      }

      body.panel-open .time-filter-bar {
        left: 400px;
      }

      .time-filter-label {
        color: #888;
        font-size: 9px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-right: 8px;
      }

      .time-filter-btn {
        background: #0a0a0a;
        border: 2px solid #00ff00;
        color: #00ff00;
        font-size: 10px;
        font-weight: bold;
        padding: 6px 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: "Press Start 2P", cursive;
      }

      .time-filter-btn:hover {
        background: #00ff00;
        color: #0a0a0a;
        text-shadow: none;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      }

      .time-filter-btn.active {
        background: #00ff00;
        color: #0a0a0a;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      }

      /* No results message - Flashing style */
      .no-results-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(10, 10, 10, 0.95);
        color: #00ff00;
        padding: 20px 30px;
        border: 3px solid #00ff00;
        border-radius: 0;
        z-index: 3000;
        font-size: 12px;
        font-weight: bold;
        font-family: "Press Start 2P", cursive;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 10px #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5),
          inset 0 0 20px rgba(0, 255, 0, 0.1);
        animation: alarmFlash 0.5s infinite;
        display: none;
        text-align: center;
      }

      .no-results-message.visible {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Custom marker styles - Minimal terminal dots */
      .custom-marker {
        width: 10px;
        height: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .custom-marker:hover {
        transform: scale(1.5);
        box-shadow: 0 0 8px currentColor !important;
      }

      /* Custom popup style - Terminal aesthetic */
      .leaflet-popup-content-wrapper {
        background: #0a0a0a;
        border: 2px solid #00ff00;
        border-radius: 0;
        color: #00ff00;
        padding: 0;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5),
          inset 0 0 20px rgba(0, 255, 0, 0.1);
      }

      .leaflet-popup-tip {
        background: #0a0a0a;
        border: 2px solid #00ff00;
        border-top: none;
      }

      .leaflet-popup-content {
        margin: 0;
        padding: 12px 15px;
        line-height: 1.6;
        font-size: 11px;
        font-weight: bold;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
      }

      .leaflet-popup-content strong {
        color: #00ff00;
        display: block;
        margin-bottom: 6px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .leaflet-popup-content br {
        display: block;
        margin: 4px 0;
      }

      .leaflet-container a.leaflet-popup-close-button {
        color: #00ff00;
        padding: 8px;
        font-size: 18px;
        font-weight: bold;
        text-shadow: 0 0 5px #00ff00;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        right: 5px;
        top: 5px;
      }

      .leaflet-container a.leaflet-popup-close-button:hover {
        color: #0a0a0a;
        background: #00ff00;
        text-shadow: none;
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        .header-title {
          font-size: 16px;
        }

        .time-filter-bar {
          top: 62px;
          padding: 10px 12px 10px 12px;
          gap: 8px;
          flex-wrap: wrap;
        }

        .time-filter-btn {
          font-size: 8px;
          padding: 4px 8px;
        }

        .stats-bar {
          font-size: 10px;
          padding: 8px 12px;
          top: 116px;
        }

        .stat-item {
          font-size: 11px;
        }

        .side-panel {
          width: 100%;
          position: fixed;
          left: 0;
          right: 0;
          height: 60vh;
          bottom: 0;
          top: auto;
          border-right: none;
          border-top: 3px solid #00ff00;
          z-index: 1001;
        }

        .side-panel.active {
          display: block;
        }

        #map {
          width: 100vw;
          height: 100vh;
          margin-left: 0;
        }

        .map-controls {
          left: 10px;
          bottom: 10px;
          flex-direction: column;
          gap: 8px;
        }

        .control-btn {
          font-size: 10px;
          padding: 8px 10px;
        }

        .leaflet-popup-content {
          font-size: 12px;
          padding: 10px;
        }

        .leaflet-popup-content strong {
          font-size: 13px;
        }

        .info-item {
          padding: 8px 0;
        }

        .info-label {
          font-size: 9px;
        }

        .info-value {
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Side Panel -->
    <div class="side-panel" id="sidePanel">
      <div
        class="side-panel-header"
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <div class="side-panel-title" id="sidePanelTitle">CITATION DETAILS</div>
        <button
          class="control-btn"
          style="padding: 4px 8px; font-size: 10px"
          onclick="closeSidePanel()"
        >
          CLOSE
        </button>
      </div>
      <div class="side-panel-content" id="sidePanelContent">
        <div class="info-item">
          <div class="info-label">SELECT A MARKER</div>
          <div class="info-value">
            Click on a citation marker to view details
          </div>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <div class="header">
      <div class="header-title">ANN ARBOR PARKING CITATIONS</div>
      <div
        style="
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 4px;
        "
      >
        <div class="header-status">● ONLINE</div>
        <div
          class="header-recent-time"
          id="recentCitationTime"
          style="
            color: #fff;
            font-size: 10px;
            letter-spacing: 0;
            min-height: 14px;
            white-space: nowrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
              'Liberation Mono', 'Courier New', monospace;
          "
        ></div>
      </div>
    </div>

    <a href="/a2-parking/about/" class="info-link" title="How does this work?">
      <span class="info-icon">?</span>
      <span>How does this work?</span>
    </a>

    <div class="time-filter-bar" id="timeFilterBar">
      <span class="time-filter-label">VIEW:</span>
      <button
        class="time-filter-btn"
        onclick="filterByTime('all')"
        id="filterAll"
        data-time="all"
      >
        ALL
      </button>
      <button
        class="time-filter-btn"
        onclick="filterByTime('week')"
        id="filterWeek"
        data-time="week"
      >
        PAST WEEK
      </button>
      <button
        class="time-filter-btn"
        onclick="filterByTime('day')"
        id="filterDay"
        data-time="day"
      >
        PAST 24 HOURS
      </button>
      <button
        class="time-filter-btn"
        onclick="filterByTime('hour')"
        id="filterHour"
        data-time="hour"
      >
        PAST HOUR
      </button>
    </div>

    <div class="stats-bar" id="statsBar">
      <div class="stat-item">
        <span class="stat-label">TOTAL CITATIONS</span>
        <span class="stat-value" id="totalCitations">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">TOTAL AMOUNT</span>
        <span class="stat-value" id="totalAmount">$0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">CITATIONS TODAY</span>
        <span class="stat-value" id="totalCitationsToday">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">AMOUNT TODAY</span>
        <span class="stat-value" id="totalAmountToday">$0</span>
      </div>
    </div>

    <div class="map-controls">
      <button
        class="control-btn"
        onclick="resetView()"
        id="resetBtn"
        title="Reset view"
        aria-label="Reset view"
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 6V3L8 7l4 4V8c2.757 0 5 2.243 5 5s-2.243 5-5 5-5-2.243-5-5H5c0 3.866 3.134 7 7 7s7-3.134 7-7-3.134-7-7-7z"
            fill="#00ff00"
          />
        </svg>
      </button>
      <button
        class="control-btn"
        onclick="toggleTheme()"
        id="themeBtn"
        title="Toggle theme"
        aria-label="Toggle theme"
      >
        <!-- icon set by script -->
      </button>
    </div>

    <div class="legend">
      <div class="legend-header">LEGEND</div>
      <div class="legend-item">
        <div
          class="legend-marker"
          style="background: rgba(255, 0, 64, 0.7); border: 1px solid #ff0040"
        ></div>
        <span class="legend-text">>= $50: <span id="legendRed">0</span></span>
      </div>
      <div class="legend-item">
        <div
          class="legend-marker"
          style="background: rgba(255, 128, 0, 0.7); border: 1px solid #ff8000"
        ></div>
        <span class="legend-text"
          >>= $30: <span id="legendOrange">0</span></span
        >
      </div>
      <div class="legend-item">
        <div
          class="legend-marker"
          style="background: rgba(0, 255, 0, 0.7); border: 1px solid #00ff00"
        ></div>
        <span class="legend-text"
          >&lt; $30: <span id="legendGreen">0</span></span
        >
      </div>
    </div>

    <div class="loading" id="loading">LOADING CITATIONS...</div>

    <div class="no-results-message" id="noResultsMessage">
      <div>NONE FOUND</div>
      <div
        style="font-size: 10px; margin-top: 10px; opacity: 0.8"
        id="noResultsInterval"
      ></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      function closeSidePanel() {
        const panel = document.getElementById("sidePanel");
        panel.classList.remove("active");
        document.body.classList.remove("panel-open");
      }
      // Initialize map centered on Ann Arbor
      const map = L.map("map", {
        zoomControl: true,
        zoom: 13,
        center: [42.2808, -83.743],
        preferCanvas: true,
      });

      let isDarkMode = true;
      let currentTileLayer;

      // Side panel closed by default

      // Initialize with dark theme
      currentTileLayer = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 20,
        }
      ).addTo(map);

      // Icon helpers
      function getSunIcon() {
        return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\
          <circle cx="12" cy="12" r="4" fill="#00ff00"/>\
          <g stroke="#00ff00" stroke-width="2">\
            <line x1="12" y1="1" x2="12" y2="4"/>\
            <line x1="12" y1="20" x2="12" y2="23"/>\
            <line x1="1" y1="12" x2="4" y2="12"/>\
            <line x1="20" y1="12" x2="23" y2="12"/>\
            <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"/>\
            <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>\
            <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"/>\
            <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"/>\
          </g>\
        </svg>';
      }

      function getMoonIcon() {
        return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="#00ff00"/>\
        </svg>';
      }

      // Set initial theme toggle icon (action: switch to light → sun)
      (function initIcons() {
        const themeBtn = document.getElementById("themeBtn");
        if (themeBtn) themeBtn.innerHTML = getSunIcon();
      })();

      // Store citations data
      let citations = [];
      let markers = [];
      const citationToMarker = new Map();
      let usedCoordinates = new Map(); // Track coordinates to avoid overlap
      let currentTimeFilter = "all"; // Track current time filter

      // Header recent time: fixed-length scramble during load, gentle decode reveal
      let recentScrambleTimer = null;
      let recentScrambleTargetLength = null;
      function startRecentScramble(targetLength) {
        const el = document.getElementById("recentCitationTime");
        if (!el) return;
        if (recentScrambleTimer) clearInterval(recentScrambleTimer);
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:, ";
        recentScrambleTargetLength = targetLength || 22; // fallback length
        recentScrambleTimer = setInterval(() => {
          let s = "";
          for (let i = 0; i < recentScrambleTargetLength; i++) {
            s += chars[Math.floor(Math.random() * chars.length)];
          }
          el.textContent = s;
        }, 70); // smooth, not jarring
      }

      function revealRecentTime(finalText) {
        const el = document.getElementById("recentCitationTime");
        if (!el) return;
        if (recentScrambleTimer) {
          clearInterval(recentScrambleTimer);
          recentScrambleTimer = null;
        }
        const target = finalText;
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:, ";
        const currentScrambled = el.textContent; // keep the current scramble
        const length = target.length;
        // Ensure we have the right length array
        let result =
          currentScrambled.length === length
            ? Array.from(currentScrambled)
            : Array.from(
                { length: length },
                () => chars[Math.floor(Math.random() * chars.length)]
              );
        let index = 0;
        const interval = setInterval(() => {
          // Replace characters in place from left to right
          if (index < length) {
            result[index] = target[index];
            index++;
          }
          // Keep scrambling the remaining characters
          for (let i = index; i < length; i++) {
            result[i] = chars[Math.floor(Math.random() * chars.length)];
          }
          el.textContent = result.join("");
          if (index >= length) {
            clearInterval(interval);
            el.textContent = target;
          }
        }, 50);
      }

      // Load citations from API
      async function loadCitations() {
        // Estimate final length using the same formatter on current time
        const estimateFormatter = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/Detroit",
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
        const estimated = `LATEST: ${estimateFormatter.format(new Date())}`;
        startRecentScramble(estimated.length);
        try {
          const response = await fetch("/api/citations");
          const data = await response.json();

          if (data.status === "success") {
            citations = data.citations || [];

            // Log all citations at 700 Arbor St
            const arborStCitations = citations.filter(
              (c) => c.location && c.location.includes("700 Arbor St")
            );
            console.log(
              `Found ${arborStCitations.length} citations at 700 Arbor St:`,
              arborStCitations
            );

            // Show error message if there's an auth issue
            if (
              data.error &&
              (data.error.includes("authentication") ||
                data.error.includes("SUPABASE_SERVICE_ROLE_KEY"))
            ) {
              document.getElementById("loading").innerHTML = `
                 <div style="background: rgba(255, 59, 48, 0.9); padding: 20px 30px; border-radius: 16px; color: #fff; max-width: 500px; text-align: center;">
                   <div style="font-size: 24px; margin-bottom: 10px;">🔒</div>
                   <strong>Authentication Required</strong><br>
                   <div style="margin-top: 10px; font-size: 13px;">
                     Please add SUPABASE_SERVICE_ROLE_KEY to your environment variables.<br>
                     See <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">FIX_AUTH_ISSUE.md</code> for instructions.
                   </div>
                 </div>
               `;
              return;
            }

            // Show message if no citations with coordinates
            if (citations.length === 0) {
              if (data.total > 0) {
                document.getElementById("loading").innerHTML = `
                   <div style="background: rgba(255, 149, 0, 0.9); padding: 20px 30px; border-radius: 16px; color: #fff; max-width: 500px; text-align: center;">
                     <div style="font-size: 24px; margin-bottom: 10px;">📍</div>
                     <strong>No Geocoded Citations</strong><br>
                     <div style="margin-top: 10px; font-size: 13px;">
                       Found ${data.total} citations but none have coordinates.<br>
                       Run: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">python geocode_citations.py</code>
                     </div>
                   </div>
                 `;
                document.getElementById("totalCitations").textContent = "0";
                document.getElementById("totalAmount").textContent = "$0";
                return;
              }
            }

            // Update stats
            document.getElementById("totalCitations").textContent =
              citations.length.toLocaleString();
            const totalAmount = citations.reduce(
              (sum, c) => sum + (parseFloat(c.amount_due) || 0),
              0
            );
            document.getElementById("totalAmount").textContent =
              "$" +
              totalAmount.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
              });

            // Compute today's stats in America/Detroit
            const detroitTZ = "America/Detroit";
            const nowDetroit = new Date(
              new Intl.DateTimeFormat("en-US", { timeZone: detroitTZ }).format(
                new Date()
              )
            );
            const todayDetroitStr = new Intl.DateTimeFormat("en-CA", {
              timeZone: detroitTZ,
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            }).format(new Date());

            let countToday = 0;
            let amountToday = 0;
            citations.forEach((c) => {
              if (!c.issue_date) return;
              const d = new Date(c.issue_date);
              const dStr = new Intl.DateTimeFormat("en-CA", {
                timeZone: detroitTZ,
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
              }).format(d);
              if (dStr === todayDetroitStr) {
                countToday += 1;
                amountToday += parseFloat(c.amount_due) || 0;
              }
            });
            document.getElementById("totalCitationsToday").textContent =
              countToday.toLocaleString();
            document.getElementById("totalAmountToday").textContent =
              "$" +
              amountToday.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
              });

            // Update most recent citation time (America/Detroit)
            if (data.most_recent_citation_time) {
              const recent = new Date(data.most_recent_citation_time);

              if (!isNaN(recent.getTime())) {
                // Format with timeZone: 'America/Detroit' converts UTC to Eastern Time
                const formatter = new Intl.DateTimeFormat("en-US", {
                  timeZone: "America/Detroit",
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                  hour: "numeric",
                  minute: "2-digit",
                  hour12: true,
                });
                const formattedTime = formatter.format(recent);
                revealRecentTime(`LATEST: ${formattedTime}`);
                const el = document.getElementById("recentCitationTime");
                if (el) {
                  el.style.cursor = "pointer";
                  el.title = "Jump to latest citation";
                  el.onclick = () => focusLatestCitation();
                }
              }
            }

            // Calculate legend counts
            let redCount = 0; // >= $50
            let orangeCount = 0; // >= $30
            let greenCount = 0; // < $30

            citations.forEach((citation) => {
              const amount = parseFloat(citation.amount_due) || 0;
              if (amount >= 50) {
                redCount++;
              } else if (amount >= 30) {
                orangeCount++;
              } else {
                greenCount++;
              }
            });

            // Update legend counts
            document.getElementById("legendRed").textContent =
              redCount.toLocaleString();
            document.getElementById("legendOrange").textContent =
              orangeCount.toLocaleString();
            document.getElementById("legendGreen").textContent =
              greenCount.toLocaleString();

            // Geocode and place markers
            await placeMarkers();

            // Hide loading
            document.getElementById("loading").style.display = "none";
          }
        } catch (error) {
          console.error("Error loading citations:", error);
          document.getElementById("loading").textContent =
            "Error loading citations";
        }
      }

      // Get offset for duplicate coordinates
      function getOffsetCoordinates(lat, lon) {
        const coordKey = `${lat.toFixed(6)},${lon.toFixed(6)}`;

        if (!usedCoordinates.has(coordKey)) {
          usedCoordinates.set(coordKey, 1);
          return { lat, lon };
        }

        // If this coordinate is already used, add a small random offset
        const count = usedCoordinates.get(coordKey);
        usedCoordinates.set(coordKey, count + 1);

        // Create a spiral offset: each duplicate gets a slightly larger radius
        const angle = count * 137.5; // Golden angle for even distribution
        const distance = 0.00005 * count; // ~5 meters per duplicate
        const offsetLat = lat + Math.cos((angle * Math.PI) / 180) * distance;
        const offsetLon = lon + Math.sin((angle * Math.PI) / 180) * distance;

        return { lat: offsetLat, lon: offsetLon };
      }

      // Create marker for citation with coordinates
      function createMarkerForCitation(citation) {
        // Check if citation has coordinates
        if (!citation.latitude || !citation.longitude) {
          console.warn(
            "Citation missing coordinates:",
            citation.citation_number
          );
          return null;
        }

        const originalLat = parseFloat(citation.latitude);
        const originalLon = parseFloat(citation.longitude);

        // Get offset coordinates if duplicates exist
        const { lat, lon } = getOffsetCoordinates(originalLat, originalLon);

        // Create custom icon - Minimal style
        const amount = parseFloat(citation.amount_due) || 0;
        const color = getColorForAmount(citation.amount_due);
        const size = amount >= 50 ? 12 : amount >= 30 ? 10 : 8;
        const borderColor =
          amount >= 50 ? "#ff0040" : amount >= 30 ? "#ff8000" : "#00ff00";

        const customIcon = L.divIcon({
          className: "custom-marker",
          html: `<div style="width: 100%; height: 100%; background: ${color}; border: 1px solid ${borderColor};"></div>`,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
        });

        // Create marker with retro terminal popup
        const marker = L.marker([lat, lon], { icon: customIcon })
          .bindPopup(
            `
                    <strong>▶ CITATION #${citation.citation_number}</strong><br>
                    ──────────────────────<br>
                    LOC: ${citation.location || "UNKNOWN"}<br>
                    AMT: $${(parseFloat(citation.amount_due) || 0).toFixed(
                      2
                    )}<br>
                    PLT: ${citation.plate_state || ""} ${
              citation.plate_number || ""
            }<br>
                    ──────────────────────
                `,
            {
              className: "terminal-popup",
            }
          )
          .addTo(map);

        // Keep reference to the marker by citation number
        if (citation.citation_number) {
          citationToMarker.set(String(citation.citation_number), marker);
        }

        // Add click handler - auto-focus and show side panel
        marker.on("click", () => {
          // Auto-focus on original coordinates (not offset)
          map.setView([originalLat, originalLon], 16);

          // Show side panel with citation details
          showCitationDetails(citation);
        });

        return marker;
      }

      // Focus and open the latest citation
      function focusLatestCitation() {
        if (!citations.length) return;
        let latest = citations[0];
        for (const c of citations) {
          if (new Date(c.issue_date) > new Date(latest.issue_date)) latest = c;
        }
        const marker = citationToMarker.get(String(latest.citation_number));
        if (marker) {
          const lat = parseFloat(latest.latitude);
          const lon = parseFloat(latest.longitude);
          map.setView([lat, lon], 16);
          marker.openPopup();
          showCitationDetails(latest);
        }
      }

      // Get color based on amount - Minimal opacity
      function getColorForAmount(amount) {
        const amt = parseFloat(amount) || 0;
        if (amt >= 50) return "rgba(255, 0, 64, 0.7)"; // Red with opacity
        if (amt >= 30) return "rgba(255, 128, 0, 0.7)"; // Orange with opacity
        return "rgba(0, 255, 0, 0.7)"; // Green with opacity
      }

      // Place all markers
      async function placeMarkers() {
        // Create markers for all citations
        citations.forEach((citation) => {
          const marker = createMarkerForCitation(citation);
          if (marker) {
            markers.push(marker);
          }
        });
      }

      // Focus map on markers
      function focusMap() {
        if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      }

      // Reset view to Ann Arbor
      function resetView() {
        map.setView([42.2808, -83.743], 13);
      }

      // Show citation details in side panel
      function showCitationDetails(citation) {
        const panel = document.getElementById("sidePanel");
        const title = document.getElementById("sidePanelTitle");
        const content = document.getElementById("sidePanelContent");

        // Show the panel and shift layout
        panel.classList.add("active");
        document.body.classList.add("panel-open");

        title.textContent = `CITATION #${citation.citation_number}`;

        content.innerHTML = `
           <div class="info-item">
             <div class="info-label">LOCATION</div>
             <div class="info-value">${citation.location || "Unknown"}</div>
           </div>
           <div class="info-item">
             <div class="info-label">ISSUE DATE</div>
             <div class="info-value">${new Intl.DateTimeFormat("en-US", {
               timeZone: "America/Detroit",
               month: "short",
               day: "numeric",
               year: "numeric",
               hour: "numeric",
               minute: "2-digit",
               hour12: true,
             }).format(new Date(citation.issue_date))}</div>
           </div>
           <div class="info-item">
             <div class="info-label">AMOUNT DUE</div>
             <div class="info-value">$${(
               parseFloat(citation.amount_due) || 0
             ).toFixed(2)}</div>
           </div>
           <div class="info-item">
             <div class="info-label">PLATE</div>
             <div class="info-value">${citation.plate_state || ""} ${
          citation.plate_number || ""
        }</div>
           </div>
           ${
             citation.violations && citation.violations.length > 0
               ? `
           <div class="info-item">
             <div class="info-label">VIOLATIONS</div>
             <div class="info-value">${
               Array.isArray(citation.violations)
                 ? citation.violations.join(", ")
                 : citation.violations
             }</div>
           </div>
           `
               : ""
           }
           ${
             citation.comments
               ? `
           <div class="info-item">
             <div class="info-label">COMMENTS</div>
             <div class="info-value">${citation.comments}</div>
           </div>
           `
               : ""
           }
           ${
             citation.more_info_url
               ? `
           <div class="info-item">
             <div class="info-label"></div>
             <div class="info-value"><a href="${citation.more_info_url}" target="_blank" style="color: #00ff00;">VIEW MORE INFO →</a></div>
           </div>
           `
               : ""
           }
         `;
      }

      // Toggle between light and dark mode
      function toggleTheme() {
        isDarkMode = !isDarkMode;

        // Remove current tile layer
        map.removeLayer(currentTileLayer);

        if (isDarkMode) {
          // Dark theme
          currentTileLayer = L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
            {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
              subdomains: "abcd",
              maxZoom: 20,
            }
          );
          document.getElementById("themeBtn").innerHTML = getSunIcon();
        } else {
          // Light theme
          currentTileLayer = L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
            {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
              subdomains: "abcd",
              maxZoom: 20,
            }
          );
          document.getElementById("themeBtn").innerHTML = getMoonIcon();
        }

        currentTileLayer.addTo(map);
      }

      // Filter citations by time period
      function filterByTime(period) {
        currentTimeFilter = period;

        // Update button states
        document.querySelectorAll(".time-filter-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.dataset.time === period) {
            btn.classList.add("active");
          }
        });

        // Hide no results message initially
        const noResultsMsg = document.getElementById("noResultsMessage");
        noResultsMsg.classList.remove("visible");

        // Calculate cutoff time in America/Detroit timezone
        const detroitTZ = "America/Detroit";
        const nowDetroit = new Date();

        let cutoffTime;
        if (period === "hour") {
          cutoffTime = new Date(nowDetroit.getTime() - 60 * 60 * 1000);
        } else if (period === "day") {
          cutoffTime = new Date(nowDetroit.getTime() - 24 * 60 * 60 * 1000);
        } else if (period === "week") {
          cutoffTime = new Date(nowDetroit.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else {
          cutoffTime = null; // Show all
        }

        // Filter and show/hide markers
        let visibleCount = 0;
        citations.forEach((citation) => {
          if (!citation.citation_number) return;

          const marker = citationToMarker.get(String(citation.citation_number));
          if (!marker) return;

          if (cutoffTime === null) {
            // Show all
            if (!map.hasLayer(marker)) {
              marker.addTo(map);
            }
            visibleCount++;
          } else {
            // Check if citation issue_date is within the time period
            if (citation.issue_date) {
              const issueDate = new Date(citation.issue_date);
              if (issueDate >= cutoffTime) {
                if (!map.hasLayer(marker)) {
                  marker.addTo(map);
                }
                visibleCount++;
              } else {
                if (map.hasLayer(marker)) {
                  marker.removeFrom(map);
                }
              }
            } else {
              // No issue date, hide it
              if (map.hasLayer(marker)) {
                marker.removeFrom(map);
              }
            }
          }
        });

        // Show no results message if no citations found
        if (visibleCount === 0 && period !== "all") {
          let intervalText = "";
          if (period === "hour") {
            intervalText = "NONE FOUND IN THE LAST HOUR";
          } else if (period === "day") {
            intervalText = "NONE FOUND IN THE LAST 24 HOURS";
          } else if (period === "week") {
            intervalText = "NONE FOUND IN THE LAST WEEK";
          }
          document.getElementById("noResultsInterval").textContent =
            intervalText;
          noResultsMsg.classList.add("visible");
        } else {
          noResultsMsg.classList.remove("visible");
        }

        // Update stats based on visible citations
        updateStatsForFilter(period, cutoffTime);
      }

      // Update statistics for filtered citations
      function updateStatsForFilter(period, cutoffTime) {
        let filteredCitations = citations;

        if (cutoffTime !== null) {
          filteredCitations = citations.filter((c) => {
            if (!c.issue_date) return false;
            const issueDate = new Date(c.issue_date);
            return issueDate >= cutoffTime;
          });
        }

        // Update total citations and amount
        document.getElementById("totalCitations").textContent =
          filteredCitations.length.toLocaleString();
        const totalAmount = filteredCitations.reduce(
          (sum, c) => sum + (parseFloat(c.amount_due) || 0),
          0
        );
        document.getElementById("totalAmount").textContent =
          "$" +
          totalAmount.toLocaleString(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          });

        // Update legend counts for filtered citations
        let redCount = 0;
        let orangeCount = 0;
        let greenCount = 0;

        filteredCitations.forEach((citation) => {
          const amount = parseFloat(citation.amount_due) || 0;
          if (amount >= 50) {
            redCount++;
          } else if (amount >= 30) {
            orangeCount++;
          } else {
            greenCount++;
          }
        });

        document.getElementById("legendRed").textContent =
          redCount.toLocaleString();
        document.getElementById("legendOrange").textContent =
          orangeCount.toLocaleString();
        document.getElementById("legendGreen").textContent =
          greenCount.toLocaleString();
      }

      // Initialize filter button - set "all" as active
      (function initFilterButtons() {
        const filterAllBtn = document.getElementById("filterAll");
        if (filterAllBtn) {
          filterAllBtn.classList.add("active");
        }
      })();

      // Load citations on page load
      loadCitations();
    </script>
  </body>
</html>
